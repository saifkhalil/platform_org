{% extends "platform_org/base.html" %}
{% load form_tags %}
{% block title %}{% if object %}Edit{% else %}New{% endif %} Service{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h4 class="card-title mb-0">
                    <i class="bi bi-pencil-square me-2"></i>{% if object %}Edit{% else %}New{% endif %} Service
                </h4>
            </div>
            <div class="card-body p-4">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}

                    {% for field in form %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                {{ field.label }}
                            </label>
                            {% with "form-control" as classes %}
                                {% if field.errors %}
                                    {{ field|add_class:classes|add_class:"is-invalid" }}
                                {% else %}
                                    {{ field|add_class:classes }}
                                {% endif %}
                            {% endwith %}
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                            {% for error in field.errors %}
                                <div class="invalid-feedback">
                                    {{ error }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a class="btn btn-light px-4" href="javascript:history.back()">
                            Cancel
                        </a>
                        <button class="btn btn-primary px-4" type="submit">
                            <i class="bi bi-check-lg me-1"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% if object %}
        <!-- SLA Cost Configuration Section (only shown when editing) -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-currency-dollar me-2 text-warning"></i>SLA Cost Configuration
                </h5>
                <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#addSLACostModal">
                    <i class="bi bi-plus-lg me-1"></i>Add SLA Cost
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>SLA Template</th>
                                <th>Cost (Base)</th>
                                <th>Cost per Quantity</th>
                                <th>Cost per Period</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sc in object.sla_costs.all %}
                            <tr>
                                <td>
                                    <span class="badge bg-info-subtle text-info border border-info-subtle">
                                        {{ sc.sla_template.name }}
                                    </span>
                                </td>
                                <td class="text-success fw-semibold">${{ sc.cost|floatformat:2 }}</td>
                                <td class="text-muted small">
                                    <span class="badge bg-secondary-subtle text-secondary">Quantity-based</span>
                                    ${{ sc.cost|floatformat:2 }} Ã— qty
                                </td>
                                <td class="text-muted small">
                                    <span class="badge bg-secondary-subtle text-secondary">Period-based</span>
                                    ${{ sc.cost|floatformat:2 }} / period
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editSLACost({{ sc.id }}, '{{ sc.sla_template.name }}', {{ sc.cost }})" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteSLACost({{ sc.id }})" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">
                                    <i class="bi bi-cash-stack fs-2 d-block mb-2"></i>
                                    No SLA-specific costs configured. Add costs for different SLA templates to enable flexible pricing.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if object %}
<!-- Modal for Add/Edit SLA Cost -->
<div class="modal fade" id="addSLACostModal" tabindex="-1" aria-labelledby="addSLACostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSLACostModalLabel">Add SLA Cost</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sla-cost-form">
                    {% csrf_token %}
                    <input type="hidden" id="sla_cost_id" name="sla_cost_id">
                    <div class="mb-3">
                        <label for="sla_template" class="form-label">SLA Template</label>
                        <select class="form-select" id="sla_template" name="sla_template" required>
                            <option value="">Select SLA Template</option>
                            {% for sla in sla_templates %}
                                <option value="{{ sla.id }}">{{ sla.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cost" class="form-label">Cost</label>
                        <input type="number" step="0.01" class="form-control" id="cost" name="cost" required>
                        <div class="form-text">This cost will be used for both quantity-based and period-based billing.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSLACost()">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
function editSLACost(id, slaName, cost) {
    document.getElementById('sla_cost_id').value = id;
    document.getElementById('cost').value = cost;
    document.getElementById('sla_template').value = '';
    document.getElementById('sla_template').disabled = true;
    document.getElementById('addSLACostModalLabel').innerText = 'Edit SLA Cost: ' + slaName;
    const modal = new bootstrap.Modal(document.getElementById('addSLACostModal'));
    modal.show();
}

function deleteSLACost(id) {
    if (!confirm('Are you sure you want to delete this SLA cost?')) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "platform_org:service_sla_cost_delete" object.id %}';
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    form.appendChild(csrfInput);
    
    const idInput = document.createElement('input');
    idInput.type = 'hidden';
    idInput.name = 'sla_cost_id';
    idInput.value = id;
    form.appendChild(idInput);
    
    document.body.appendChild(form);
    form.submit();
}

function saveSLACost() {
    const form = document.getElementById('sla-cost-form');
    const formData = new FormData(form);
    
    fetch('{% url "platform_org:service_sla_cost_manage" object.id %}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error saving SLA cost');
        }
    });
}

// Reset modal when opening for new entry
document.getElementById('addSLACostModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('sla-cost-form').reset();
    document.getElementById('sla_cost_id').value = '';
    document.getElementById('sla_template').disabled = false;
    document.getElementById('addSLACostModalLabel').innerText = 'Add SLA Cost';
});
</script>
{% endif %}

<script>
    // Form validation
    (function () {
      'use strict'
      var forms = document.querySelectorAll('.needs-validation')
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault()
              event.stopPropagation()
            }
            form.classList.add('was-validated')
          }, false)
        })
    })()
</script>
{% endblock %}
