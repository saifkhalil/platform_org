{% extends "platform_org/base.html" %}
{% block title %}{{ s.name }} - Service Details{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'platform_org:service_list' %}">Service Catalog</a></li>
                    {% if s.parent %}
                        <li class="breadcrumb-item"><a href="{% url 'platform_org:service_detail' s.parent.id %}">{{ s.parent.name }}</a></li>
                    {% endif %}
                    <li class="breadcrumb-item active">{{ s.name }}</li>
                </ol>
            </nav>
            <div class="btn-group">
                <a href="{% url 'platform_org:service_create' %}?parent={{ s.id }}&provider_me={{ s.provider_me.id }}" class="btn btn-outline-success">
                    <i class="bi bi-plus-circle me-1"></i>Add Sub-service
                </a>
                <a href="{% url 'platform_org:service_edit' s.id %}" class="btn btn-outline-primary">
                    <i class="bi bi-pencil me-1"></i>Edit
                </a>
                <a href="{% url 'platform_org:service_delete' s.id %}" class="btn btn-outline-danger">
                    <i class="bi bi-trash me-1"></i>Delete
                </a>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h4 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2 text-primary"></i>Service Details
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h3 class="fw-bold mb-1">{{ s.name }}</h3>
                        <p class="text-muted mb-4">{{ s.provider_me.name }}</p>
                        
                        {% if s.description %}
                            <h5 class="fw-semibold">Description</h5>
                            <p class="text-secondary">{{ s.description|linebreaks }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4 border-start">
                        <div class="mb-3">
                            <label class="text-muted small d-block">Cost</label>
                            <span class="fs-4 fw-bold text-success">${{ s.cost|floatformat:2 }}</span>
                        </div>
                        {% if s.sla_costs.exists %}
                        <div class="mb-3">
                            <label class="text-muted small d-block">SLA Specific Costs</label>
                            <ul class="list-unstyled mb-0">
                                {% for sc in s.sla_costs.all %}
                                <li>
                                    <span class="small fw-semibold">{{ sc.sla_template.name }}:</span>
                                    <span class="text-success">${{ sc.cost|floatformat:2 }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            <label class="text-muted small d-block">SLA Template</label>
                            {% if s.sla_template %}
                                <span class="badge bg-info-subtle text-info border border-info-subtle fs-6">
                                    {{ s.sla_template.name }}
                                </span>
                            {% else %}
                                <span class="text-muted">None assigned</span>
                            {% endif %}
                        </div>
                        {% if s.parent %}
                        <div class="mb-3">
                            <label class="text-muted small d-block">Parent Service</label>
                            <a href="{% url 'platform_org:service_detail' s.parent.id %}" class="text-decoration-none">
                                <i class="bi bi-arrow-up-circle me-1"></i>{{ s.parent.name }}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-currency-dollar me-2 text-warning"></i>SLA Cost Configuration
                </h5>
                <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#addSLACostModal">
                    <i class="bi bi-plus-lg me-1"></i>Add SLA Cost
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>SLA Template</th>
                                <th>Cost (Base)</th>
                                <th>Cost per Quantity</th>
                                <th>Cost per Period</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sc in s.sla_costs.all %}
                            <tr>
                                <td>
                                    <span class="badge bg-info-subtle text-info border border-info-subtle">
                                        {{ sc.sla_template.name }}
                                    </span>
                                </td>
                                <td class="text-success fw-semibold">${{ sc.cost|floatformat:2 }}</td>
                                <td class="text-muted small">
                                    <span class="badge bg-secondary-subtle text-secondary">Quantity-based</span>
                                    ${{ sc.cost|floatformat:2 }} Ã— qty
                                </td>
                                <td class="text-muted small">
                                    <span class="badge bg-secondary-subtle text-secondary">Period-based</span>
                                    ${{ sc.cost|floatformat:2 }} / period
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editSLACost({{ sc.id }}, '{{ sc.sla_template.name }}', {{ sc.cost }})" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteSLACost({{ sc.id }})" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">
                                    <i class="bi bi-cash-stack fs-2 d-block mb-2"></i>
                                    No SLA-specific costs configured. Add costs for different SLA templates to enable flexible pricing.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-diagram-3 me-2 text-success"></i>Sub-services
                </h5>
                <a href="{% url 'platform_org:service_create' %}?parent={{ s.id }}&provider_me={{ s.provider_me.id }}" class="btn btn-sm btn-success">
                    <i class="bi bi-plus-lg me-1"></i>Add Sub-service
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Cost</th>
                                <th>SLA</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub in s.sub_services.all %}
                            <tr>
                                <td>
                                    <a href="{% url 'platform_org:service_detail' sub.id %}" class="fw-bold text-decoration-none">
                                        {{ sub.name }}
                                    </a>
                                    {% if sub.description %}
                                        <div class="small text-muted text-truncate" style="max-width: 300px;">{{ sub.description }}</div>
                                    {% endif %}
                                </td>
                                <td class="text-success fw-semibold">${{ sub.cost|floatformat:2 }}</td>
                                <td>
                                    {% if sub.sla_template %}
                                        <span class="badge bg-info-subtle text-info">{{ sub.sla_template.name }}</span>
                                    {% else %}
                                        <span class="text-muted small">None</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <a class="btn btn-outline-primary" href="{% url 'platform_org:service_edit' sub.id %}"><i class="bi bi-pencil"></i></a>
                                        <a class="btn btn-outline-danger" href="{% url 'platform_org:service_delete' sub.id %}"><i class="bi bi-trash"></i></a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">
                                    No sub-services defined for this service.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Add/Edit SLA Cost -->
<div class="modal fade" id="addSLACostModal" tabindex="-1" aria-labelledby="addSLACostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSLACostModalLabel">Add SLA Cost</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="slaCostForm" method="post">
                {% csrf_token %}
                <input type="hidden" id="slaCostId" name="sla_cost_id" value="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="slaTemplate" class="form-label">SLA Template</label>
                        <select class="form-select" id="slaTemplate" name="sla_template" required>
                            <option value="">Select SLA Template...</option>
                            {% for sla in sla_templates %}
                            <option value="{{ sla.id }}">{{ sla.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cost" class="form-label">Cost</label>
                        <input type="number" step="0.01" class="form-control" id="cost" name="cost" required>
                        <div class="form-text">
                            This cost will be used for both Quantity-based and Period-based billing calculations.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editSLACost(id, slaName, cost) {
    document.getElementById('slaCostId').value = id;
    document.getElementById('cost').value = cost;
    document.getElementById('addSLACostModalLabel').textContent = 'Edit SLA Cost - ' + slaName;
    
    // Disable SLA template selection when editing
    document.getElementById('slaTemplate').disabled = true;
    
    var modal = new bootstrap.Modal(document.getElementById('addSLACostModal'));
    modal.show();
}

function deleteSLACost(id) {
    if (confirm('Are you sure you want to delete this SLA cost configuration?')) {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "platform_org:service_sla_cost_delete" s.id %}';
        
        var csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        var idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'sla_cost_id';
        idInput.value = id;
        form.appendChild(idInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Reset modal when opening for new entry
document.getElementById('addSLACostModal').addEventListener('show.bs.modal', function (event) {
    if (!event.relatedTarget || !event.relatedTarget.hasAttribute('onclick')) {
        document.getElementById('slaCostId').value = '';
        document.getElementById('cost').value = '';
        document.getElementById('slaTemplate').disabled = false;
        document.getElementById('slaTemplate').value = '';
        document.getElementById('addSLACostModalLabel').textContent = 'Add SLA Cost';
    }
});

// Handle form submission
document.getElementById('slaCostForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    var formData = new FormData(this);
    var url = '{% url "platform_org:service_sla_cost_manage" s.id %}';
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Error saving SLA cost. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving SLA cost. Please try again.');
    });
});
</script>
{% endblock %}